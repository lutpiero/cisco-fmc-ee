on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-ee-with-patched-collection:
    runs-on: ubuntu-latest
    env:
      IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/cisco-fmc-ee:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install build tools (ansible-core, ansible-builder, pyyaml)
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade ansible-core ansible-builder pyyaml

      - name: Clone upstream collection (CiscoDevNet/FMCAnsible)
        run: |
          rm -rf /tmp/FMCAnsible
          git clone https://github.com/CiscoDevNet/FMCAnsible.git /tmp/FMCAnsible
          ls -la /tmp/FMCAnsible

      - name: Resolve merge conflict in upstream requirements.txt (keep main side)
        run: |
          cd /tmp/FMCAnsible
          # If there's no conflict markers, this will just copy the file back unchanged.
          awk '
            /^<<<<<<< / { in_conflict=1; next }
            /^=======/ { in_conflict=2; next }
            /^>>>>>>> / { in_conflict=0; next }
            { if(in_conflict==2 || in_conflict==0) print }
          ' requirements.txt > requirements.txt.ci.cleaned || (echo "awk failed" && exit 1)
          mv requirements.txt.ci.cleaned requirements.txt
          echo "Cleaned requirements.txt preview:"
          sed -n '1,200p' requirements.txt

      - name: Build patched collection artifact
        run: |
          cd /tmp/FMCAnsible
          python -m pip install --upgrade ansible-core
          ansible-galaxy collection build -v -f -o /tmp/artifacts
          ls -la /tmp/artifacts

      - name: Install built collection into runner workspace (vendor collections)
        run: |
          mkdir -p $GITHUB_WORKSPACE/collections
          ansible-galaxy collection install /tmp/artifacts/*.tar.gz --collections-path $GITHUB_WORKSPACE/collections
          echo "Installed collections under $GITHUB_WORKSPACE/collections:"
          ls -la $GITHUB_WORKSPACE/collections/ansible_collections || true

      - name: Copy vendored collections into build overlay
        run: |
          mkdir -p $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections
          cp -r $GITHUB_WORKSPACE/collections/ansible_collections/* $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections/ || true
          echo "Overlay contents:"
          ls -la $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections || true

      - name: Inject copy step into execution-environment.yml (CI-only)
        run: |
          python - <<'PY'
          import sys, yaml, pathlib
          ee = pathlib.Path("execution-environment.yml")
          if not ee.exists():
              print("execution-environment.yml not found; aborting", file=sys.stderr)
              sys.exit(1)
          data = yaml.safe_load(ee.read_text()) or {}
          data.setdefault('dependencies', {})
          # Preserve existing entries if present
          data['dependencies'].setdefault('galaxy', 'requirements.yml')
          data['dependencies'].setdefault('python', 'requirements.txt')
          # Exec-form command to copy vendored collections from the build context into the image
          copy_cmd = ["/bin/sh", "-c", "mkdir -p /usr/share/ansible/collections && cp -r /build/bindep-overlay/collections/ansible_collections/* /usr/share/ansible/collections || true"]
          data.setdefault('additional_build_steps', {})
          data['additional_build_steps']['prepend_galaxy'] = [copy_cmd]
          ee.write_text(yaml.safe_dump(data, sort_keys=False))
          print("Wrote modified execution-environment.yml for CI.")
          PY
          echo "---- modified execution-environment.yml ----"
          sed -n '1,200p' execution-environment.yml || true

      - name: Install ansible-builder and run EE build (use python -m to ensure correct binary)
        env:
          DOCKER_BUILDKIT: 1
        run: |
          python -m pip install --upgrade ansible-builder ansible-core
          python -m ansible_builder.cli build -v -t "$IMAGE"

      - name: Upload build context for debugging on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ee-build-context
          path: context
