# CI workflow: Patch CiscoDevNet/FMCAnsible requirements, build the collection,
# vendor it into the build context, ensure execution-environment.yml will copy
# the vendored collection into /usr/share/ansible/collections inside the image,
# then run ansible-builder to build the EE image.
#
# Trigger this manually (workflow_dispatch) so you can review runs before merging.
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-ee-with-patched-collection:
    runs-on: ubuntu-latest
    env:
      IMAGE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/cisco-fmc-ee:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install build tools (ansible-core, ansible-builder, pyyaml)
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade ansible-core ansible-builder pyyaml

      - name: Clone upstream collection (CiscoDevNet/FMCAnsible)
        run: |
          rm -rf /tmp/FMCAnsible
          git clone https://github.com/CiscoDevNet/FMCAnsible.git /tmp/FMCAnsible
          ls -la /tmp/FMCAnsible

      - name: Apply merge-conflict fix to upstream requirements.txt
        run: |
          # Create a patch that resolves the conflict in requirements.txt (keep newer/main side)
          cat > /tmp/fix-requirements.patch <<'PATCH'
*** Begin Patch
*** Update File: requirements.txt
@@
-<<<<<<< HEAD
-ansible>=2.10.7
-urllib3>=1.26.5
-lxml>=4.6.3
-=======
-#ansible==2.10.7
-ansible>=2.17.0
-#urllib3==1.26.5
-urllib3
-lxml==4.6.3
-requests>=2.25.0
->>>>>>> main
-
+ansible>=2.17.0
+urllib3>=1.26.5
+lxml==4.6.3
+requests>=2.25.0
+
*** End Patch
PATCH
          # Apply patch to the cloned repo
          cd /tmp/FMCAnsible
          git apply /tmp/fix-requirements.patch || (echo "git apply failed; showing file:" && sed -n '1,200p' requirements.txt && false)
          echo "Patched file preview:"
          sed -n '1,200p' requirements.txt

      - name: Build patched collection artifact
        run: |
          cd /tmp/FMCAnsible
          # Ensure we have ansible-galaxy available (from ansible-core)
          python -m pip install --upgrade ansible-core
          # Build collection tarball
          ansible-galaxy collection build -v -f -o /tmp/artifacts
          ls -la /tmp/artifacts

      - name: Install built collection into runner workspace (vendor collections)
        run: |
          mkdir -p $GITHUB_WORKSPACE/collections
          ansible-galaxy collection install /tmp/artifacts/*.tar.gz --collections-path $GITHUB_WORKSPACE/collections
          echo "Installed collections under $GITHUB_WORKSPACE/collections:"
          ls -la $GITHUB_WORKSPACE/collections/ansible_collections || true

      - name: Copy vendored collections into build overlay
        run: |
          # This overlay will be included in the ansible-builder context so we can copy it into the image
          mkdir -p $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections
          cp -r $GITHUB_WORKSPACE/collections/ansible_collections/* $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections/ || true
          echo "Overlay contents:"
          ls -la $GITHUB_WORKSPACE/bindep-overlay/collections/ansible_collections || true

      - name: Inject copy step into execution-environment.yml (CI-only)
        run: |
          # Add a prepend_galaxy exec-form step to copy the vendored collections from the build context
          # into /usr/share/ansible/collections inside the image before ansible-galaxy runs.
          #
          # This avoids network collection installs during the in-image ansible-galaxy step.
          python - <<'PY'
          import sys, yaml, pathlib
          ee = pathlib.Path("execution-environment.yml")
          if not ee.exists():
              print("execution-environment.yml not found in repo root; aborting", file=sys.stderr)
              sys.exit(1)
          data = yaml.safe_load(ee.read_text()) or {}
          # Ensure basic structure
          if 'dependencies' not in data:
              data['dependencies'] = {}
          # Ensure python/galaxy are kept (do not overwrite if present)
          data['dependencies'].setdefault('galaxy', 'requirements.yml')
          data['dependencies'].setdefault('python', 'requirements.txt')
          # Add stage-specific prepend to galaxy stage using exec-form command array
          abs_copy_cmd = [
              "bash", "-lc",
              "mkdir -p /usr/share/ansible/collections && cp -r /build/bindep-overlay/collections/ansible_collections/* /usr/share/ansible/collections || true"
          ]
          data.setdefault('additional_build_steps', {})
          # Insert or replace prepend_galaxy
          data['additional_build_steps']['prepend_galaxy'] = [abs_copy_cmd]
          # Write to a CI-specific EE file (but overwrite the repository file so ansible-builder reads it)
          ee.write_text(yaml.safe_dump(data, sort_keys=False))
          print("Wrote modified execution-environment.yml for CI.")
          PY
          echo "---- modified execution-environment.yml ----"
          sed -n '1,200p' execution-environment.yml || true

      - name: Install ansible-builder and run EE build (use python -m to ensure correct binary)
        env:
          DOCKER_BUILDKIT: 1
        run: |
          python -m pip install --upgrade ansible-builder ansible-core
          # Use python -m ansible_builder.cli so the installed package is definitely invoked
          python -m ansible_builder.cli build -v -t "$IMAGE"

      # Optional: push the built image to Docker Hub (uncomment if you want to push)
      # - name: Log in to Docker Hub
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #
      # - name: Push image
      #   run: |
      #     docker push "$IMAGE"

      - name: Upload build logs (artifact) for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ee-build-workspace
          path: context || .
